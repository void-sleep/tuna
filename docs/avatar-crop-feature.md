# 头像裁剪功能使用说明

## 功能概述

用户上传头像时，可以对图片进行裁剪、缩放和预览，确保头像显示效果最佳。

## 主要特性

### 1. 图片裁剪
- **圆形裁剪区域**: 自动裁剪成圆形头像
- **拖拽调整**: 拖动图片调整裁剪位置
- **1:1 比例**: 保持正方形比例，适合各种显示场景

### 2. 缩放功能
- **缩放范围**: 1x - 3x
- **滑块控制**: 通过滑块精确控制缩放级别
- **实时预览**: 缩放时立即看到效果

### 3. 实时预览
- **裁剪区域预览**: 左侧黑色区域显示裁剪范围
- **最终效果预览**: 右下角小圆圈显示最终头像效果
- **操作指引**: 清晰的文字提示

### 4. 自动同步更新
- **设置页面**: 上传后立即显示新头像
- **右上角菜单**: 自动同步更新 UserMenu 中的头像
- **好友列表**: 好友看到的你的头像也会更新

## 使用流程

```
选择图片 → 验证文件 → 打开裁剪对话框 → 调整位置和缩放 → 预览效果 → 确认上传 → 自动更新
```

### 详细步骤

1. **选择图片**
   - 点击设置页面的头像区域
   - 或点击"上传头像"/"更换头像"按钮
   - 选择图片文件（支持 jpg, png, gif, webp）

2. **文件验证**
   - 自动检查文件类型（必须是图片）
   - 检查文件大小（最大 5MB）
   - 通过验证后打开裁剪对话框

3. **裁剪调整**
   - 拖动图片调整位置
   - 使用滑块缩放图片（1x-3x）
   - 观察右下角预览效果

4. **确认上传**
   - 点击"确认上传"按钮
   - 系统自动处理裁剪
   - 上传到 Supabase Storage
   - 更新数据库中的 avatar_url

5. **自动刷新**
   - 设置页面头像立即更新
   - 右上角 UserMenu 头像同步更新
   - 无需手动刷新页面

## 技术实现

### 前端组件

**AvatarCropDialog.tsx**
- 使用 `react-easy-crop` 库
- 圆形裁剪模式
- Canvas API 处理图片

### 上传流程

```typescript
handleFileSelect (选择文件)
  ↓
  验证文件类型和大小
  ↓
  读取为 Data URL
  ↓
  打开裁剪对话框
  ↓
handleCropComplete (裁剪完成)
  ↓
  Canvas 处理裁剪区域
  ↓
  转换为 Blob (JPEG 95% 质量)
  ↓
uploadAvatarAction (上传到 Supabase)
  ↓
  更新 profiles 表
  ↓
router.refresh() (刷新页面数据)
```

### 存储结构

```
Supabase Storage: avatars bucket
└── {user_id}/
    └── {timestamp}.jpg
```

### 数据库更新

```sql
UPDATE profiles
SET avatar_url = 'https://xxx.supabase.co/storage/v1/object/public/avatars/{user_id}/{timestamp}.jpg'
WHERE id = {user_id};
```

## 文件大小优化

- **上传前**: 最大 5MB
- **裁剪后**: 通常 < 200KB
- **压缩质量**: JPEG 95%
- **自动清理**: 上传新头像时删除旧文件

## 浏览器兼容性

支持所有现代浏览器：
- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+

需要的浏览器特性：
- Canvas API
- FileReader API
- Blob API

## 故障排查

### 裁剪对话框不显示
- 检查是否成功选择了文件
- 查看浏览器 Console 是否有错误
- 确认文件类型是图片

### 上传后头像不更新
- 检查 Supabase Storage 配置
- 确认 RLS 策略正确
- 清除浏览器缓存

### 预览效果不正确
- 尝试调整缩放级别
- 重新拖动图片位置
- 关闭对话框重新选择图片
