# Ta是谁 - 中国亲戚关系与称呼指南

## 应用概述

### 定位

帮助用户理清亲戚关系、快速查询正确称呼的工具，同时支持建立个人家谱。

### 核心功能

1. **称呼速查** - 通过路径选择（我→爸爸→姐姐→儿子）即可得出称呼，无需录入任何数据
2. **家谱管理** - 以"我"为中心录入亲属信息，构建可视化关系图
3. **图上交互** - 点击关系图中任意成员，显示双向称呼（我叫 Ta 什么 / Ta 叫我什么）
4. **智能引导** - 查询未录入的亲属时，友好提示是否将其加入家谱

### 应用类型

- 类型标识：`family_tree`
- 数据隐私：完全私有，每个用户只能访问自己的家谱数据

## 数据模型

### 亲属成员表 `family_members`

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| id | UUID | 是 | 主键 |
| user_id | UUID | 是 | 所属用户（RLS 隔离） |
| nickname | TEXT | 是 | 称呼/昵称（如"大伯"、"小姨"） |
| real_name | TEXT | 否 | 真实姓名 |
| gender | TEXT | 是 | 性别（male/female，用于推算称呼） |
| birth_date | DATE | 否 | 生日 |
| avatar_type | TEXT | 是 | 默认头像类型 |
| avatar_url | TEXT | 否 | 自定义照片 URL（优先于默认头像） |
| notes | TEXT | 否 | 备注 |
| is_self | BOOLEAN | 是 | 是否为"我"（每个用户有且仅有一个） |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |

**默认头像类型**：

- `elder_male` / `elder_female` - 老年男性/女性
- `adult_male` / `adult_female` - 中年男性/女性
- `youth_male` / `youth_female` - 青年男性/女性
- `child` - 儿童

### 亲属关系表 `family_relations`

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| id | UUID | 是 | 主键 |
| user_id | UUID | 是 | 所属用户 |
| from_member_id | UUID | 是 | 起点成员 |
| to_member_id | UUID | 是 | 终点成员 |
| relation_type | TEXT | 是 | 关系类型 |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |

**关系类型**（仅 5 种基础关系）：

- `father` - 父亲
- `mother` - 母亲
- `son` - 儿子
- `daughter` - 女儿
- `spouse` - 配偶

其他所有称呼通过路径计算得出。

### 称呼配置表 `kinship_terms`（系统级）

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| id | UUID | 是 | 主键 |
| relation_path | TEXT | 是 | 关系路径（如 "father.sister.son"） |
| gender | TEXT | 是 | 目标性别 |
| term_standard | TEXT | 是 | 标准称呼（如 "表哥/表弟"） |
| term_reverse | TEXT | 是 | 反向称呼（Ta 叫我什么） |
| region | TEXT | 是 | 地区（default/北方/南方/四川/广东 等） |
| priority | INT | 是 | 优先级（同路径多方言时排序） |

## 称呼计算引擎

### 计算逻辑

1. **路径解析**：从"我"到目标成员，遍历 `family_relations` 构建路径
   - 例：我 → 父亲 → 父亲的姐姐 → 姐姐的儿子 = `father.sister.son`

2. **称呼匹配**：用路径 + 性别查询 `kinship_terms`
   - 先查用户偏好地区，无结果则 fallback 到 `default`

3. **年龄修饰**：部分称呼需要比较年龄（哥/弟、姐/妹）
   - 有生日数据：精确比较
   - 无生日数据：提示用户选择或显示"表哥/表弟"

4. **双向显示**：同时返回 `term_standard`（我叫 Ta）和 `term_reverse`（Ta 叫我）

### 称呼覆盖范围

**标准级（约 50 种称呼）**：

- 直系：父母、祖父母、外祖父母、曾祖辈、子女、孙辈、玄孙辈
- 旁系：兄弟姐妹、叔伯姑舅姨、堂/表兄弟姐妹、侄子女
- 姻亲：配偶、公婆、岳父母、妯娌、连襟、嫂子、弟媳等
- 再婚：继父母、继子女

**方言变体**：

- 作为可选扩展，数据驱动
- 不影响核心功能
- 可持续添加，无需改动代码

## 可视化设计

### 双视图模式

**1. 放射图（默认视图）**

- "我"居中，亲属按代际/亲疏环绕分布
- 父母辈在上方，子女辈在下方，配偶在侧边
- 同辈（兄弟姐妹、堂表亲）按年龄横向排列
- 连线显示关系，颜色区分直系/旁系
- 支持缩放、拖拽平移

**2. 树状图（可切换）**

- 传统家谱风格，祖先在上，后代在下
- 适合查看完整世系结构
- 右上角切换按钮

### 成员卡片

- 头像（默认图标或自定义照片）
- 昵称/姓名
- 点击触发详情弹窗

### 成员详情弹窗

- 头像 + 昵称/姓名
- **我叫 Ta：XX**（大字突出）
- **Ta 叫我：XX**
- 关系路径：爸爸的姐姐的儿子
- 可选的方言变体（如有）
- 操作按钮：编辑 / 删除

## 交互设计

### 路径选择器（速查工具）

- **入口**：顶部工具栏"快速查称呼"按钮
- **交互**：级联选择器，逐级选择关系
  - 第一级：父亲/母亲/配偶/兄弟/姐妹/儿子/女儿
  - 后续级：根据前一级动态展示可选关系
- **结果**：显示称呼 + "是否添加到家谱？"引导按钮

### 引导录入流程

当用户通过路径选择器查询某个称呼后：

1. 显示查询结果（称呼 + 反向称呼）
2. 提示"要把这位亲戚添加到家谱吗？"
3. 点击后弹出简化版录入表单（预填关系路径）
4. 录入完成后，自动在关系图中显示

## 页面结构

### 路由

| 路由 | 说明 |
| --- | --- |
| `/applications/[id]/run` | 应用运行页（关系图 + 交互） |
| `/apps/applications/[id]/edit` | 应用编辑页（家谱管理） |

### 组件清单

**运行页组件**：

- `FamilyTreeRunner` - 主容器，管理视图状态
- `RadialGraph` - 放射图组件
- `TreeGraph` - 树状图组件
- `MemberCard` - 成员卡片
- `MemberDetailPanel` - 成员详情弹窗
- `RelationPathPicker` - 路径选择器

**编辑页组件**：

- `FamilyTreeEditor` - 编辑主容器
- `MemberForm` - 成员信息表单
- `RelationPicker` - 关系选择器
- `AvatarSelector` - 头像选择器（默认图标 + 上传）
- `MemberList` - 成员列表

### 融入现有架构

- `ApplicationType` 新增 `family_tree` 类型
- `APP_TYPE_STYLES` 新增样式：温暖的琥珀色系 `from-slate-900 via-amber-950/50 to-slate-900`，图标 🌳
- 应用 `config` 字段存储：默认视图偏好、地区方言偏好

## 技术选型

| 领域 | 选型 | 理由 |
| --- | --- | --- |
| 关系图渲染 | React Flow | 与 React 生态契合，交互友好，支持自定义节点 |
| 称呼库存储 | 数据库表 | 支持动态扩展方言变体，无需部署即可更新 |
| 路径计算 | 前端 + 后端混合 | 简单查询前端计算，复杂路径后端处理 |

## 实现计划

### Phase 1：核心基础

- 数据库表设计与迁移（family_members、family_relations、kinship_terms）
- 称呼库初始数据（标准级 ~50 种称呼）
- 基础 API（成员 CRUD、关系 CRUD、称呼查询）
- 简单列表视图（先跑通流程）

### Phase 2：可视化

- 放射图实现（React Flow）
- 成员卡片与点击交互
- 成员详情弹窗（双向称呼展示）
- 树状图实现与视图切换

### Phase 3：速查工具

- 路径选择器组件
- 称呼计算引擎完善（年龄比较、边界处理）
- "添加到家谱"引导流程

### Phase 4：体验优化

- 默认头像图标集
- 方言变体数据扩充
- 地区偏好设置
- 空状态引导（首次使用教程）
